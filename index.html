<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Format Preview</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet" />
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        /* Fidelity Sans Font */
        @font-face {
            font-family: 'Fidelity Sans';
            src: url('https://www.fidelity.com/webcontent/fonts/fidelity-sans/v2-2021/regular/FidelitySans-Regular.woff2') format('woff2'),
                 url('https://www.fidelity.com/webcontent/fonts/fidelity-sans/v2-2021/regular/FidelitySans-Regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        @font-face {
            font-family: 'Fidelity Sans';
            src: url('https://www.fidelity.com/webcontent/fonts/fidelity-sans/v2-2021/bold/FidelitySans-Bold.woff2') format('woff2'),
                 url('https://www.fidelity.com/webcontent/fonts/fidelity-sans/v2-2021/bold/FidelitySans-Bold.woff') format('woff');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }
        
        /* Typography settings */
        :root {
            --fidelity-line-height: 1.5;
            --fidelity-letter-spacing: -0.01em;
            --fidelity-header-letter-spacing: -0.02em;
        }
        
        /* Apply box-sizing globally */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Fidelity Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            line-height: var(--fidelity-line-height);
            letter-spacing: var(--fidelity-letter-spacing);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Ensure list font size is standard */
        /* Updated for p, ol, ul */
        p, ol, ul {
            font-size: 14px;
            line-height: 20px; /* Updated */
            font-weight: normal; /* Added for regular */
            letter-spacing: -0.25px; /* Added */
        }

        .header {
            text-align: center;
            padding: 15px 20px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .app-container {
            display: flex;
            flex: 1;
            min-height: 0;
        }
        .nav-sidebar {
            width: 220px;
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            overflow-y: auto;
            flex-shrink: 0;
            transition: width 0.3s ease;
            position: relative;
        }
        .nav-sidebar.collapsed {
            width: 50px;
        }
        .nav-sidebar.collapsed .nav-item-text {
            display: none;
        }
        .nav-sidebar.collapsed .nav-item {
            text-align: center;
            padding: 12px 0;
        }
        .nav-sidebar.collapsed .nav-item-icon {
            margin-right: 0;
        }
        .nav-sidebar.collapsed .sidebar-toggle {
            margin: 0 auto 20px auto;
        }
        .sidebar-toggle {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            font-size: 14px;
            z-index: 10;
            margin: 0 20px 20px auto;
        }
        .sidebar-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .sidebar-toggle-icon {
            font-size: 16px;
        }
        .nav-item-text {
            transition: opacity 0.2s ease;
        }
        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
        }
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .nav-item.active {
            border-left-color: #6200ea;
            background-color: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }
        .nav-item-icon {
            margin-right: 10px;
            opacity: 0.8;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex; /* Added */
            flex-direction: column; /* Added */
        }
        .container {
            /* max-width: 1200px; Removed */
            /* margin: 0 auto; Removed */
            /* Changed from grid to flex for standardization */
            display: flex; 
            /* grid-template-columns: 1fr 1fr; Removed */ 
            gap: 20px;
        }
        /* Removed container.ai-view rule as flex handles single column when needed */

        .view-container {
            display: none;
            flex-grow: 1;
            flex-direction: column;
        }

        /* NEW: Standardized container styles for all tabs */
        .view-container .container {
            display: flex; 
            flex-direction: row; 
            gap: 20px; 
            padding: 0; /* Standardized to 0 */
            max-width: 100%; 
            flex-grow: 1; 
            min-height: 0; 
            height: calc(100vh - 120px); /* Standardized height */
        }

        .view-container.active {
            display: flex;
        }
        
        /* Error notification styling */
        .error-container {
            background-color: #fff3f3;
            border-left: 4px solid #dc3545;
            margin: 0 32px 20px 32px;
            padding: 12px 16px;
            border-radius: 4px;
            display: none;
            font-size: 14px;
            color: #721c24;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .error-container.visible {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .error-title {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .error-message {
            margin: 0;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .text-box {
            /* Moved common styles here */
            background: white;
            border-radius: 8px;
            padding: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            /* height: 620px; Removed fixed height */
            display: flex;
            flex-direction: column;
            /* Added standard flex/sizing/height */
            flex: 1; 
            overflow: hidden; 
            min-height: 0; 
            height: 100%; /* Ensure full height within container */
        }
        .text-box h2 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #333;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            letter-spacing: var(--fidelity-header-letter-spacing);
            width: 100%;
        }
        .text-box h2 span {
            display: inline-block;
        }
        .heading-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        textarea {
            width: 100%;
            height: 130px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: 'Fidelity Sans', inherit;
            flex-shrink: 0;
            line-height: var(--fidelity-line-height);
            letter-spacing: var(--fidelity-letter-spacing);
        }
        .preview-box {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 400px;
            overflow-y: auto;
            overflow-x: auto;
            position: relative;
            flex-shrink: 0;
            width: auto;
            max-width: 100%;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            flex-shrink: 0;
            font-family: 'Fidelity Sans', inherit;
        }
        button:hover {
            background-color: #0056b3;
        }
        .header h1 {
            color: #333;
            letter-spacing: var(--fidelity-header-letter-spacing);
            font-size: 1.5em;
            margin: 0 0 5px 0;
        }
        .header p {
            color: #666;
            margin: 0;
            font-size: 0.9em;
        }
        .copy-button {
            background-color: #6c757d;
            padding: 5px 10px;
            font-size: 0.8em;
        }
        .copy-button:hover {
            background-color: #5a6268;
        }
        .export-button {
            background-color: #17a2b8;
        }
        .export-button:hover {
            background-color: #138496;
        }
        .copy-success {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #28a745; /* Default green background */
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
            z-index: 9999;
        }
        /* AI Success Toast Style - ONLY defines the background override */
        .toast-ai {
            background-color: #6200ea !important; /* Purple background - use !important to ensure override */
        }

        pre {
            margin: 0 !important;
            padding: 0 !important;
            background: none !important;
            max-width: 100% !important;
            overflow-x: auto !important;
        }
        code {
            font-family: 'Fira Code', monospace;
            display: block;
            max-width: 100% !important;
            overflow-x: auto !important;
        }
        .preview-container {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            max-width: 100%;
            overflow: hidden;
            position: relative;
        }
        .toggle-container {
            display: flex;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        .toggle-button {
            padding: 6px 12px;
            background-color: #eee;
            color: #333;
            border: 1px solid #ddd;
            cursor: pointer;
            outline: none;
            flex: 1;
        }
        .toggle-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        /* Added hover style for toggle buttons */
        .toggle-button:hover {
            color: white;           /* Set text color to white on hover */
            background-color: #0056b3; /* Darker blue background on hover */
            border-color: #0056b3;     /* Match border color */
        }
        .toggle-button:first-child {
            border-radius: 4px 0 0 4px;
        }
        .toggle-button:last-child {
            border-radius: 0 4px 4px 0;
        }
        .preview-content {
            display: none;
            max-width: 100%;
            height: 100%;
        }
        .preview-content.active {
            display: block;
            max-width: 100%;
            height: 100%;
        }
        .html-code {
            white-space: pre;
            max-width: 100%;
            overflow-x: auto;
            overflow-wrap: normal;
            word-break: keep-all;
        }
        
        /* Override Prism.js styles to prevent expansion */
        .token {
            white-space: pre;
            display: inline;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 10px;
        }
        
        .tab {
            padding: 5px 10px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
        }
        
        .tab.active {
            border-color: #ddd;
            border-radius: 4px 4px 0 0;
            background-color: white;
            position: relative;
        }
        
        .tab.active:after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: white;
        }
        
        .tab-content {
            display: none;
            height: 100%;
        }
        
        .tab-content.active {
            display: block;
            height: 100%;
        }
        
        .rendered-html {
            max-width: 100%;
            overflow-wrap: break-word;
        }
        
        /* Quill editor custom styles */
        #editor-container {
            height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        
        .ql-editor {
            font-size: 14px;
            line-height: var(--fidelity-line-height);
            font-family: 'Fidelity Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            letter-spacing: var(--fidelity-letter-spacing);
        }
        
        .button-bar {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
            justify-content: center;
        }
        
        .format-actions {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .raw-text {
            display: none;
        }
        
        /* Card Preview Styles */
        .card-preview-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background-color: #f0f0f0;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            overflow: auto; /* Changed from auto to hidden if parent scrolls */
            /* Added max-height and revised overflow for Tab 1 */
            max-height: calc(100% - 50px); 
            overflow-y: auto;
        }
        
        .card-preview {
            width: 450px;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #ccc;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin: 0 auto;
            box-sizing: border-box;
            overflow-wrap: break-word;
            font-family: 'Fidelity Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: var(--fidelity-line-height);
            letter-spacing: var(--fidelity-letter-spacing);
        }
        
        .card-preview img {
            max-width: 100%;
            height: auto;
        }
        
        .format-toggle {
            display: flex;
            justify-content: space-between;
            margin: 0 0 15px 0;
        }
        
        .section-label {
            font-weight: bold;
            margin-top: 5px;
            margin-bottom: 3px;
            color: #555;
            border-bottom: 1px solid #eee;
            padding-bottom: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            letter-spacing: var(--fidelity-header-letter-spacing);
        }
        
        .output-container {
            position: relative;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0;
        }
        
        .copy-corner-button {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            background-color: rgba(108, 117, 125, 0.8);
            border-radius: 4px;
            padding: 5px 10px;
            color: white;
            font-size: 12px;
        }
        
        .copy-corner-button:hover {
            background-color: rgba(90, 98, 104, 0.9);
        }
        
        .card-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
        }
        
        .return-icon {
            margin-right: 8px;
            font-weight: bold;
            font-size: 18px;
            transform: scaleX(-1);
        }
        
        .intent-label {
            font-weight: bold;
            color: #333;
            letter-spacing: var(--fidelity-header-letter-spacing);
            font-size: 14px; /* Added font size */
        }
        
        .card-content {
            margin-top: 16px;
            font-family: 'Fidelity Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: var(--fidelity-line-height);
            letter-spacing: var(--fidelity-letter-spacing);
        }
        
        /* Apply Fidelity typography to all headings */
        /* General heading styles (can be overridden) */
        h1, h2, h3, h4, h5, h6 {
            letter-spacing: var(--fidelity-header-letter-spacing); /* Keeps default unless overridden */
            line-height: 1.3; /* Keeps default unless overridden */
        }

        /* Specific heading styles */
        h1 {
            font-size: 20px;
            line-height: 24px;
            font-weight: bold;
            letter-spacing: -0.25px;
        }

        h2 {
            font-size: 18px;
            line-height: 24px;
            font-weight: bold;
            letter-spacing: -0.25px;
        }
        
        /* Apply Fidelity typography to paragraph elements in the preview */
        /* Note: The global 'p' rule above might affect this. Keep for potential specificity needs. */
        .card-content p {
            margin-bottom: 1em;
            line-height: var(--fidelity-line-height);
            letter-spacing: var(--fidelity-letter-spacing);
            font-size: 14px;
        }
        
        #inputText {
            flex-grow: 1;
            margin: 0;
        }
        
        .import-button {
            background-color: #28a745;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .import-button:hover {
            background-color: #218838;
        }
        
        .import-button svg {
            width: 16px;
            height: 16px;
        }
        
        .file-input {
            display: none;
        }
        
        .import-status {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            display: none;
        }
        
        .import-success {
            color: #28a745;
        }
        
        .import-error {
            color: #dc3545;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: flex-start;
            padding-top: 100px;
        }
        
        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            width: 750px; /* Increased from 500px to 750px (50% wider) */
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
        }
        
        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .modal-actions {
            padding: 16px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        
        .modal-button {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .modal-button-cancel {
            background-color: #f1f1f1;
            color: #333;
        }
        
        .modal-button-proceed {
            background-color: #4a6ee0;
            color: white;
        }
        
        .modal-options {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .modal-option {
            padding: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s ease;
        }
        
        .modal-option:hover {
            border-color: #4a6ee0;
            background-color: #f7f9ff;
        }
        
        .modal-option.selected {
            border-color: #4a6ee0;
            background-color: #f7f9ff;
        }
        
        .modal-option-icon {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-option-icon svg {
            width: 32px;
            height: 32px;
        }
        
        .modal-option-text {
            flex-grow: 1;
        }
        
        .modal-option-title {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .modal-option-desc {
            color: #666;
            font-size: 13px;
        }
        
        .modal-controls-bar {
            padding: 8px 16px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 16px;
        }
        
        /* Modal Tab Styles */
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid #f0f0f0;
            background-color: #f8f8f8;
        }
        
        .modal-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.2s ease;
        }
        
        .modal-tab:hover {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .modal-tab.active {
            border-bottom-color: #4a6ee0;
            color: #4a6ee0;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        /* Toast Messages */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* === Floating Preview Button === */
        #showPreviewButton {
            position: fixed;
            right: 20px;
            /* top: 50%; */ /* Removed */
            /* transform: translateY(-50%); */ /* Removed */
            bottom: 20px; /* Added */
            background-color: #6200ea; /* Match AI theme */
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            cursor: pointer;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 998; /* Below modals */
            transition: background-color 0.2s ease;
        }
        #showPreviewButton svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        #showPreviewButton:hover {
            background-color: #3700b3;
        }
        /* Modified to show for tab-two OR tab-three */
        body.tab-two-active #showPreviewButton,
        body.tab-three-active #showPreviewButton {
            display: flex; /* Show when tab 2 or 3 is active */
        }
        /* === End Floating Preview Button === */

        /* === Modal Open Body Lock === */
        body.modal-open {
            overflow: hidden; /* Prevent body scrolling when any modal is open */
        }
        /* === End Modal Open Body Lock === */

        /* === Modal Controls Bar === */
        .modal-controls-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px; /* Space below controls */
        }
        /* === End Modal Controls Bar === */

        /* === Download Preview Button === */
        .download-preview-button {
            display: block;
            background-color: #6c757d; /* Standard gray */
            color: white;
            padding: 6px 12px;
            font-size: 0.85em;
            border-radius: 4px;
            margin: 15px auto 0 auto; /* Top margin, centered */
            width: fit-content;
            border: none;
            cursor: pointer;
            flex-shrink: 0; /* Prevent shrinking in flex context */
        }
        .download-preview-button:hover {
            background-color: #5a6268;
        }
        /* === End Download Preview Button === */

        .style-selector {
            margin-left: auto; /* Remove this if now in a flex-end container */
            min-width: 140px;
            position: relative;
        }
        
        select.style-dropdown {
            appearance: none;
            -webkit-appearance: none;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 30px 5px 10px;
            font-size: 0.85em;
            cursor: pointer;
            font-family: inherit;
            width: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 12px;
        }
        
        select.style-dropdown:hover {
            background-color: #e6e6e6;
        }
        
        select.style-dropdown:focus {
            outline: none;
            border-color: #aaa;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        /* Card Preview Styles */
        .card-pill-container {
            display: flex;
            gap: 8px;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        
        .card-pill {
            display: inline-block;
            padding: 6px 14px;
            background-color: #f0f0f0;
            border-radius: 20px;
            font-size: 0.85em;
            color: #555;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .card-pill:hover {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .card-pill-primary {
            background-color: #e3f2fd;
            border-color: #90caf9;
            color: #0d47a1;
        }
        
        .card-pill-primary:hover {
            background-color: #bbdefb;
            color: #0d47a1;
        }
        
        .card-pill-secondary {
            background-color: #f3e5f5;
            border-color: #ce93d8;
            color: #7b1fa2;
        }
        
        .card-pill-secondary:hover {
            background-color: #e1bee7;
            color: #7b1fa2;
        }
        
        /* Card style variations */
        .card-preview.text-only .card-header {
            display: none;
        }
        
        .card-preview.with-pills .card-pill-container {
            display: flex;
        }
        
        .card-preview:not(.with-pills) .card-pill-container {
            display: none;
        }
        
        /* Make section label items align better */
        .section-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        /* Tab One specific styles to maximize space */
        /* REMOVED #tab-one .text-box block as styles are now general */
        
        /* REMOVED #tab-one .container block as styles are now general */
        
        #tab-one #editor-pane {
            flex: 1; 
            display: flex;
            flex-direction: column;
            min-height: 0; /* Important for nested flex items */
            overflow: hidden;
        }
        
        #tab-one #output-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0; /* Important for nested flex items */
            overflow: hidden;
        }
        
        #tab-one #editor-container {
            flex: 1; /* Take all available space */
            display: flex;
            flex-direction: column;
            min-height: 0; /* Important for nested flex containers */
            overflow: hidden; /* Prevent overflow */
            height: auto !important; /* Override any inline height */
        }
        
        #tab-one .output-container {
            flex: 1; /* Fill available space */
            display: flex;
            flex-direction: column;
            min-height: 0; /* Important for nested flex items */
        }
        
        #tab-one #inputText {
            flex: 1; /* Fill the container */
            min-height: 0; /* Important for flex child */
            resize: none; /* Disable resize */
        }
        
        /* Fix for Quill editor internals */
        #tab-one .ql-container {
            flex: 1 !important;
            min-height: 0 !important;
            height: auto !important;
        }
        
        #tab-one .ql-editor {
            flex: 1 !important;
            min-height: 0 !important;
            height: auto !important;
            overflow-y: auto !important;
        }
        
        #tab-one .import-status {
            margin-top: 10px;
            position: absolute;
            bottom: 15px;
        }
        
        /* Tab Two specific styles to maximize space */
        /* REMOVED #tab-two .text-box block as styles are now general */
        
        /* REMOVED #tab-two .container block as styles are now general */

        #tab-two #editor-container2 {
            /* height: 350px; */ /* Removed fixed height */
            flex-grow: 1; /* Added to fill space */
            display: flex; /* Added for inner Quill elements */
            flex-direction: column; /* Added for inner Quill elements */
            overflow: hidden; /* Added to prevent container scrollbars */
        }
        
        
        #tab-two .output-container {
            height: calc(100% - 120px);
            flex-grow: 1;
        }
        
        #tab-two #inputText2 {
            height: 100%;
            flex-grow: 1;
        }
        
        #tab-two .import-status {
            margin-top: 10px;
            position: absolute;
            bottom: 15px;
        }
        
        /* AI Button Styles */
        #aiFormatButton {
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }
        
        #aiFormatButton svg {
            width: 16px;
            height: 16px;
        }
        
        #aiFormatButton.loading {
            background-color: #666;
            pointer-events: none;
        }
        
        /* AI Loader Animation */
        .ai-loader {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: ai-spin 1s ease-in-out infinite;
        }
        
        @keyframes ai-spin {
            to { transform: rotate(360deg); }
        }
        
        /* Clear button styles */
        .clear-button {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background-color: #dc3545;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            display: none;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s ease;
            z-index: 10;
        }
        
        .clear-button:hover {
            background-color: #c82333;
        }
        
        .clear-button svg {
            width: 16px;
            height: 16px;
        }
        
        /* === Resizable Pane Styles === */
        #editor-pane,
        #output-pane {
            flex: 1; /* Start by sharing space */
            min-height: 100px; /* Minimum height */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent internal content from causing overflow */
        }
        
        #output-pane {
             min-height: 150px; /* Needs more space for controls */
        }

        #resize-handle {
            height: 8px;
            background-color: #e0e0e0;
            cursor: ns-resize;
            flex-shrink: 0; /* Prevent handle from shrinking */
            margin: 4px 0;
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
        }
        /* === End Resizable Pane Styles === */

        /* === Quick Action Menu Styles === */
        .card-separator {
            border: none;
            border-top: 1px solid #eee;
            margin: 16px 0;
        }

        .quick-action-menu {
            display: flex;
            justify-content: flex-start; /* Align icons to the left */
            gap: 12px; /* Space between icons */
        }

        .action-item {
            display: inline-flex; /* Align icon nicely */
            align-items: center;
            justify-content: center;
            padding: 6px;
            border-radius: 50%; /* Circular background */
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .action-item svg {
            width: 18px;
            height: 18px;
            fill: #666; /* Default icon color */
        }

        .action-item:hover {
            background-color: #f0f0f0; /* Light background on hover */
        }
        
        /* Visibility control */
        .card-preview:not(.with-quick-actions) .card-separator,
        .card-preview:not(.with-quick-actions) .quick-action-menu {
            display: none;
        }
        /* === End Quick Action Menu Styles === */

        /* Card style variations */
        .card-preview.text-only .card-header {
            display: none;
        }
        
        .card-preview.with-pills .card-pill-container {
            display: flex;
        }
        
        .card-preview:not(.with-pills) .card-pill-container {
            display: none;
        }
        
        /* Make section label items align better */
        .section-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Content Format Preview</h1>
        <p>Create and preview your content in different formats</p>
    </div>
    
    <!-- Global error notification container -->
    <div id="globalErrorContainer" class="error-container">
        <div class="error-title">Error</div>
        <p class="error-message" id="globalErrorMessage"></p>
    </div>
    
    <div class="app-container">
        <div class="nav-sidebar">
            <button class="sidebar-toggle" id="sidebarToggle">
                <svg class="sidebar-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <div class="nav-item active" data-view="tab-one">
                <span class="nav-item-icon">✏️</span>
                <span class="nav-item-text">Editor</span>
            </div>
            <div class="nav-item" data-view="tab-two">
                <span class="nav-item-icon">🤖</span>
                <span class="nav-item-text">AI Format</span>
            </div>
            <div class="nav-item" data-view="tab-three">
                <span class="nav-item-icon">⚙️</span> <!-- Example icon -->
                <span class="nav-item-text">AI Process</span>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Tab One View -->
            <div id="tab-one" class="view-container active">
                <div class="container">
                    <div class="text-box">
                        <h2>
                            <span>Content Editor</span>
                            <div class="heading-actions">
                                <button id="importButton" class="import-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    Import File
                                </button>
                                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.doc,.docx">
                            </div>
                        </h2>
                        
                        <!-- Wrap editor in its own pane -->
                        <div id="editor-pane">
                            <!-- Quill editor container with relative positioning -->
                            <div style="position: relative; flex-grow: 1; display: flex; flex-direction: column;">
                                <div id="editor-container"></div>
                                
                                <!-- Clear button positioned within editor area -->
                                <!-- Button removed as requested -->
                            </div>
                            <!-- Hidden textarea to store raw content -->
                            <textarea id="rawContent" class="raw-text"></textarea>
                            <!-- Import status moved inside output pane now -->
                        </div> 

                        <!-- Draggable Resize Handle -->
                        <div id="resize-handle"></div>

                        <!-- Wrap output section in its own pane -->
                        <div id="output-pane">
                            <!-- Format toggle -->
                            <div class="section-label">
                                Display Options
                                <button id="copyButton" class="copy-button" onclick="copyCurrentFormat()">Copy HTML to Clipboard</button>
                            </div>
                            <div class="toggle-container">
                                <button id="htmlToggle" class="toggle-button active" onclick="toggleFormat('html')">Show HTML</button>
                                <button id="markdownToggle" class="toggle-button" onclick="toggleFormat('markdown')">Show Markdown</button>
                            </div>
                            
                            <!-- Raw text output -->
                            <div class="output-container">
                                <textarea id="inputText" placeholder="Formatted code will appear here..."></textarea>
                            </div>
                            <!-- Moved import status here -->
                             <div id="importStatus" class="import-status"></div>
                        </div>
                    </div>
                    
                    <div class="text-box">
                        <h2>
                            <span>Card Preview</span>
                            <div class="heading-actions">
                                <!-- Screenshot Button for Tab 1 removed -->
                                <div class="style-selector">
                                    <select id="cardStyleSelector" class="style-dropdown">
                                        <option value="text-only">Text Only</option>
                                        <option value="with-intent" selected>With User Intent</option>
                                        <option value="with-pills">With Intent & Pills</option>
                                        <option value="with-quick-actions">With Quick Action Menu</option> <!-- Added -->
                                    </select>
                                </div>
                            </div>
                        </h2>
                        <div class="preview-container">
                            <!-- Card Preview -->
                            <div id="cardPreview" class="preview-content active preview-box">
                                <div class="card-preview-container">
                                    <div class="card-preview with-intent" id="cardPreviewContent">
                                        <div class="card-header">
                                            <span class="return-icon">↩</span>
                                            <span class="intent-label">User Intent</span>
                                        </div>
                                        <div class="card-content" id="cardContentArea1"></div>
                                        <div class="card-pill-container">
                                            <span class="card-pill">Option 1</span>
                                            <span class="card-pill">Option 2</span>
                                            <span class="card-pill">Option 3</span>
                                        </div>
                                        <!-- Separator and Quick Actions -->
                                        <hr class="card-separator">
                                        <div class="quick-action-menu">
                                            <span class="action-item" title="Copy">
                                                <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
                                            </span>
                                            <span class="action-item" title="Thumbs Up">
                                                <svg viewBox="0 0 24 24"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"></path></svg>
                                            </span>
                                            <span class="action-item" title="Thumbs Down">
                                                 <svg viewBox="0 0 24 24"><path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"></path></svg>
                                            </span>
                                            <span class="action-item" title="Share">
                                                 <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"></path></svg>
                                            </span>
                                        </div>
                                        <!-- End Separator and Quick Actions -->
                                        <!-- Removed button from here -->
                                    </div>
                                </div>
                                <!-- Download button moved here (Tab 1) -->
                                <button id="screenshotButtonTab1" class="download-preview-button">Download Preview</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Two View (modified layout) -->
            <div id="tab-two" class="view-container">
                <div class="container">
                    <div class="text-box">
                        <h2>
                            <span>Content Editor</span>
                            <div class="heading-actions">
                                <button id="importButton2" class="import-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    Import File
                                </button>
                                <button id="aiFormatButton" class="import-button" style="background-color: #6200ea;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="3" y1="9" x2="21" y2="9"></line>
                                        <path d="M9 21V9"></path>
                                        <path d="M15 9v3"></path>
                                        <path d="M15 15v6"></path>
                                        <circle cx="15" cy="12" r="0.5"></circle>
                                        <circle cx="15" cy="18" r="0.5"></circle>
                                    </svg>
                                    Format with AI
                                </button>
                                <button id="aiConfigButton" style="background: none; border: none; padding: 8px 5px; cursor: pointer; margin-left: 0;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#6200ea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
                                        <circle cx="12" cy="12" r="2"></circle>
                                        <path d="M12 6V4"></path>
                                        <path d="M12 20v-2"></path>
                                        <path d="M6 12H4"></path>
                                        <path d="M20 12h-2"></path>
                                        <path d="M16.24 7.76l-1.42 1.42"></path>
                                        <path d="M9.18 14.82l-1.42 1.42"></path>
                                        <path d="M16.24 16.24l-1.42-1.42"></path>
                                        <path d="M9.18 9.18l-1.42-1.42"></path>
                                    </svg>
                                </button>
                                <input type="file" id="fileInput2" class="file-input" accept=".xlsx,.xls,.doc,.docx">
                            </div>
                        </h2>
                        
                        <!-- Quill editor container with relative positioning -->
                        <div style="position: relative; flex-grow: 1; display: flex; flex-direction: column;">
                            <div id="editor-container2"></div>
                            <!-- Clear button for editor 2 never existed here -->
                        </div>
                        
                        <!-- Hidden textarea to store raw content -->
                        <textarea id="rawContent2" class="raw-text"></textarea>
                        
                        <!-- Import options - remove section but keep status -->
                        <div id="importStatus2" class="import-status"></div>
                        
                    </div> <!-- Moved this closing tag here to end the Content Editor text-box -->
                        
                    <!-- This Display Options text-box is now a sibling -->
                    <div class="text-box"> 
                        <h2>
                            <span>Display Options</span>
                            <button id="copyButton2" class="copy-button" onclick="copyCurrentFormat2()">Copy HTML to Clipboard</button>
                        </h2>
                        
                        <div class="toggle-container">
                            <button id="htmlToggle2" class="toggle-button active" onclick="toggleFormat2('html')">Show HTML</button>
                            <button id="markdownToggle2" class="toggle-button" onclick="toggleFormat2('markdown')">Show Markdown</button>
                        </div>
                        
                        <!-- Raw text output -->
                        <div class="output-container">
                            <textarea id="inputText2" placeholder="Formatted code will appear here..."></textarea>
                        </div>
                    </div> <!-- This was the original location of the closing tag -->
                </div>
            </div>
            
            <!-- Tab Three View (New - Cloned from Tab Two) -->
            <div id="tab-three" class="view-container"> <!-- ID changed -->
                <div class="container"> <!-- Using the same container class -->
                    <div class="text-box"> <!-- Using the same text-box class -->
                        <h2>
                            <span>AI Processing Step</span> <!-- Changed Title -->
                            <div class="heading-actions">
                                <button id="importButton3" class="import-button"> <!-- ID changed -->
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    Import File
                                </button>
                                <button id="aiFormatButton3" class="import-button" style="background-color: #6200ea;"> <!-- ID changed -->
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <!-- Re-using AI icon, could change -->
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="3" y1="9" x2="21" y2="9"></line>
                                        <path d="M9 21V9"></path>
                                        <path d="M15 9v3"></path>
                                        <path d="M15 15v6"></path>
                                        <circle cx="15" cy="12" r="0.5"></circle>
                                        <circle cx="15" cy="18" r="0.5"></circle>
                                    </svg>
                                    Process with AI <!-- Changed Button Text -->
                                </button>
                                <!-- Config button can potentially be shared or specific -->
                                <button id="aiConfigButton3" style="background: none; border: none; padding: 8px 5px; cursor: pointer; margin-left: 0;"> <!-- ID changed (for now, maybe consolidate later) -->
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#6200ea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
                                        <circle cx="12" cy="12" r="2"></circle>
                                        <path d="M12 6V4"></path>
                                        <path d="M12 20v-2"></path>
                                        <path d="M6 12H4"></path>
                                        <path d="M20 12h-2"></path>
                                        <path d="M16.24 7.76l-1.42 1.42"></path>
                                        <path d="M9.18 14.82l-1.42 1.42"></path>
                                        <path d="M16.24 16.24l-1.42-1.42"></path>
                                        <path d="M9.18 9.18l-1.42-1.42"></path>
                                    </svg>
                                </button>
                                <input type="file" id="fileInput3" class="file-input" accept=".xlsx,.xls,.doc,.docx"> <!-- ID changed -->
                            </div>
                        </h2>
                        
                        <!-- Quill editor container -->
                        <div style="position: relative; flex-grow: 1; display: flex; flex-direction: column;">
                            <div id="editor-container3"></div> <!-- ID changed -->
                            <!-- Clear button positioned within editor area (removed) -->
                        </div>
                        
                        <!-- Hidden textarea to store raw content -->
                        <textarea id="rawContent3" class="raw-text"></textarea> <!-- ID changed -->
                        
                        <!-- Import status -->
                        <div id="importStatus3" class="import-status"></div> <!-- ID changed -->
                        
                    </div> 
                        
                    <!-- Display Options box -->
                    <div class="text-box"> 
                        <h2>
                            <span>Display Options</span>
                            <button id="copyButton3" class="copy-button" onclick="copyCurrentFormat3()">Copy HTML to Clipboard</button> <!-- ID and onclick changed -->
                        </h2>
                        
                        <div class="toggle-container">
                            <button id="htmlToggle3" class="toggle-button active" onclick="toggleFormat3('html')">Show HTML</button> <!-- ID and onclick changed -->
                            <button id="markdownToggle3" class="toggle-button" onclick="toggleFormat3('markdown')">Show Markdown</button> <!-- ID and onclick changed -->
                        </div>
                        
                        <!-- Raw text output -->
                        <div class="output-container">
                            <textarea id="inputText3" placeholder="Processed code will appear here..."></textarea> <!-- ID and placeholder changed -->
                        </div>
                    </div> 
                </div>
            </div>
        </div>
    </div>

    <div id="copySuccess" class="copy-success"></div> <!-- Message set by JS -->

    <!-- Floating Preview Button (Initially Hidden) -->
    <button id="showPreviewButton" title="Show Card Preview">
        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 7h10v2H7zm0 4h10v2H7zm0 4h7v2H7z"></path></svg>
    </button>
    
    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Select Import Format</h3>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-options">
                <div class="modal-option" data-import-mode="word">
                    <div class="modal-option-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#2b579a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </div>
                    <div class="modal-option-text">
                        <div class="modal-option-title">Word Document</div>
                        <div class="modal-option-desc">Import formatted text from Word (.docx, .doc)</div>
                    </div>
                </div>
                <div class="modal-option" data-import-mode="excel-table">
                    <div class="modal-option-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#217346" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                            <line x1="3" y1="15" x2="21" y2="15"></line>
                            <line x1="9" y1="3" x2="9" y2="21"></line>
                            <line x1="15" y1="3" x2="15" y2="21"></line>
                        </svg>
                    </div>
                    <div class="modal-option-text">
                        <div class="modal-option-title">Excel (Table)</div>
                        <div class="modal-option-desc">Import entire worksheet as HTML table</div>
                    </div>
                </div>
                <div class="modal-option" data-import-mode="excel-cell">
                    <div class="modal-option-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#217346" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <rect x="9" y="9" width="6" height="6"></rect>
                        </svg>
                    </div>
                    <div class="modal-option-text">
                        <div class="modal-option-title">Excel (Single Cell)</div>
                        <div class="modal-option-desc">Import content from a single cell (A1)</div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-button modal-button-cancel" id="modalCancel">Cancel</button>
                <button class="modal-button modal-button-proceed" id="modalProceed">Proceed</button>
            </div>
        </div>
    </div>

    <!-- AI Config Modal -->
    <div id="aiConfigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">AI Configuration</h3>
                <!-- View Selector Buttons MOVED below -->
                <button class="modal-close" id="aiModalClose" style="margin-left: auto;">&times;</button>
            </div>

            <!-- NEW: Top-level Tabs for View Switching -->
            <div class="modal-tabs" style="margin-left: 0;"> <!-- Renamed class, removed inline style -->
                 <button class="modal-tab active" data-view="system-settings-view">System Settings</button> <!-- Renamed class -->
                 <button class="modal-tab" data-view="model-settings-view">Model Settings</button> <!-- Renamed class -->
            </div>

            <!-- System Settings View -->
            <div id="system-settings-view" class="modal-view active" style="padding: 16px;">
                <div style="margin-bottom: 16px;">
                    <label for="aiProvider" style="display: block; margin-bottom: 6px; font-weight: 500;">Default Provider</label>
                    <select id="aiProvider" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="openai" selected>OpenAI</option>
                        <option value="claude">Claude (Anthropic)</option>
                    </select>
                </div>
                <div style="margin-bottom: 16px;">
                    <label for="systemPrompt" style="display: block; margin-bottom: 6px; font-weight: 500;">System Prompt (AI Format Tab)</label> <!-- Clarified Label -->
                    <textarea id="systemPrompt" rows="6" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;" placeholder="Enter instructions for the initial AI formatting step...">You are a helpful assistant that formats text into clear, structured content. Create organized sections with headings, bullet points, and numbered lists as appropriate.</textarea> <!-- Reduced rows -->
                </div>
                <!-- Added System Prompt for Tab 3 -->
                <div style="margin-bottom: 16px;">
                    <label for="systemPrompt3" style="display: block; margin-bottom: 6px; font-weight: 500;">System Prompt (AI Process Tab)</label>
                    <textarea id="systemPrompt3" rows="6" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;" placeholder="Enter specific instructions for the second AI processing step...">You are a helpful assistant that refines existing formatted HTML content based on specific criteria. Analyze the structure and apply the requested changes, returning clean, valid HTML.</textarea> <!-- Default prompt added, reduced rows -->
                </div>
            </div>

            <!-- Model Settings View -->
            <div id="model-settings-view" class="modal-view" style="padding: 16px; display: none;">
                <!-- Provider Tabs (within Model Settings) -->
                <div class="modal-tabs">
                    <button class="modal-tab active" data-tab="openai-panel">OpenAI</button>
                    <button class="modal-tab" data-tab="claude-panel">Claude</button>
                </div>
                <!-- OpenAI Panel -->
                <div id="openai-panel" class="tab-panel active" style="padding-top: 16px;">
                    <!-- System Prompt removed from here -->
                    <div style="margin-bottom: 16px;">
                        <label for="aiModel" style="display: block; margin-bottom: 6px; font-weight: 500;">AI Model</label>
                        <select id="aiModel" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                            <option value="gpt-4">GPT-4 (High quality, more expensive)</option>
                            <option value="gpt-3.5-turbo" selected>GPT-3.5 Turbo (Faster, less expensive)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label for="temperature" style="display: block; margin-bottom: 6px; font-weight: 500;">Temperature: <span id="tempValue">0.7</span></label>
                        <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" style="width: 100%;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                            <span>More focused</span>
                            <span>More creative</span>
                        </div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label for="apiKey" style="display: block; margin-bottom: 6px; font-weight: 500;">OpenAI API Key</label>
                        <input type="password" id="apiKey" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;" placeholder="sk-...">
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                            Your API key is stored locally in your browser and never sent to our servers.
                        </div>
                    </div>
                </div>
                <!-- Claude Panel (New) -->
                <div id="claude-panel" class="tab-panel" style="padding-top: 16px; display: none;">
                    <!-- System Prompt removed from here -->
                    <div style="margin-bottom: 16px;">
                        <label for="claudeModel" style="display: block; margin-bottom: 6px; font-weight: 500;">Claude Model</label>
                        <select id="claudeModel" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                            <option value="claude-3-opus-20240229">Claude 3 Opus (High quality)</option>
                            <option value="claude-3-sonnet-20240229" selected>Claude 3 Sonnet (Balanced)</option>
                            <option value="claude-3-haiku-20240307">Claude 3 Haiku (Faster)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label for="claudeTemperature" style="display: block; margin-bottom: 6px; font-weight: 500;">Temperature: <span id="claudeTempValue">0.7</span></label>
                        <input type="range" id="claudeTemperature" min="0" max="1" step="0.1" value="0.7" style="width: 100%;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                            <span>More focused</span>
                            <span>More creative</span>
                        </div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label for="claudeApiKey" style="display: block; margin-bottom: 6px; font-weight: 500;">Claude API Key</label>
                        <input type="password" id="claudeApiKey" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;" placeholder="sk-ant-...">
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                            Your API key is stored locally in your browser and never sent to our servers.
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal Actions -->
            <div class="modal-actions">
                <button class="modal-button modal-button-cancel" id="aiModalCancel">Cancel</button>
                <button class="modal-button modal-button-proceed" id="aiModalSave">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal"> <!-- Reusing .modal styles -->
        <div class="modal-content" style="width: 600px; max-width: 90%;"> <!-- Wider content area -->
            <div class="modal-header">
                <h3 class="modal-title">AI Format Card Preview</h3>
                <button class="modal-close" id="previewModalClose">&times;</button>
            </div>
            <!-- Controls Bar Below Header -->
            <div class="modal-controls-bar">
                <div class="style-selector" style="margin-left: 0;"> <!-- Removed margin-left auto -->
                    <select id="modalCardStyleSelector" class="style-dropdown">
                        <option value="text-only">Text Only</option>
                        <option value="with-intent" selected>With User Intent</option>
                        <option value="with-pills">With Intent & Pills</option>
                        <option value="with-quick-actions">With Quick Action Menu</option>
                    </select>
                </div>
                <!-- Removed Screenshot Button from Modal Controls -->
            </div>
            <!-- Duplicated Preview Structure -->
            <div class="text-box" style="height: auto; box-shadow: none; padding: 0;"> 
                 <!-- Removed h2 wrapper around controls -->
                 <div class="preview-container" style="min-height: 0;"> 
                    <div id="modalCardPreview" class="preview-content active preview-box"> 
                        <!-- Adjusted max-height to make room for button -->
                        <div class="card-preview-container" style="overflow-y: auto; max-height: 60vh;">
                            <div class="card-preview with-intent" id="modalCardPreviewContent">
                                <div class="card-header">
                                    <span class="return-icon">↩</span>
                                    <span class="intent-label">User Intent</span>
                                </div>
                                <div class="card-content" id="modalCardContentArea"></div>
                                <div class="card-pill-container">
                                    <span class="card-pill">Option 1</span>
                                    <span class="card-pill">Option 2</span>
                                    <span class="card-pill">Option 3</span>
                                </div>
                                <hr class="card-separator">
                                <div class="quick-action-menu">
                                     <span class="action-item" title="Copy"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></span>
                                     <span class="action-item" title="Thumbs Up"><svg viewBox="0 0 24 24"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"></path></svg></span>
                                     <span class="action-item" title="Thumbs Down"><svg viewBox="0 0 24 24"><path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"></path></svg></span>
                                     <span class="action-item" title="Share"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"></path></svg></span>
                                </div>
                            </div>
                        </div>
                        <!-- Added Download Button outside content area but inside modal -->
                        <button id="screenshotButton" class="download-preview-button">Download Preview</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Library Scripts -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@12/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-markup.min.js"></script>
    <!-- Excel and Word parsing libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <!-- Added html2canvas library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        // Initialize Quill editor
        var quill = new Quill('#editor-container', {
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    [{ 'script': 'sub' }, { 'script': 'super' }],
                    [{ 'indent': '-1' }, { 'indent': '+1' }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: 'Compose your content here...',
            theme: 'snow'
        });
        
        // Initialize second Quill editor for Tab Two
        var quill2 = new Quill('#editor-container2', {
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    [{ 'script': 'sub' }, { 'script': 'super' }],
                    [{ 'indent': '-1' }, { 'indent': '+1' }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: 'Compose your content here...',
            theme: 'snow'
        });
        
        // Initialize third Quill editor for Tab Three
        var quill3 = new Quill('#editor-container3', {
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    [{ 'script': 'sub' }, { 'script': 'super' }],
                    [{ 'indent': '-1' }, { 'indent': '+1' }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: 'Paste content here for AI processing...', // Changed placeholder
            theme: 'snow'
        });
        
        // Initialize markdown-it
        var md = window.markdownit();
        
        // Initialize Showdown
        var converter = new showdown.Converter();
        
        // Track current format
        var currentFormat = 'html';
        var currentFormat2 = 'html';
        var currentFormat3 = 'html'; // Added for tab 3
        
        // Import mode
        var importMode = 'word'; // Default import mode
        var requestingImportTab = null; // Track which tab requested import
        
        // Modal Elements
        const importModal = document.getElementById('importModal');
        const modalClose = document.getElementById('modalClose');
        const modalCancel = document.getElementById('modalCancel');
        const modalProceed = document.getElementById('modalProceed');
        const modalOptions = document.querySelectorAll('.modal-option');
        
        // View switching elements
        const navItems = document.querySelectorAll('.nav-item');
        const viewContainers = document.querySelectorAll('.view-container');
        
        // Handle view switching
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                // Get the view to show
                const viewToShow = this.getAttribute('data-view');
                
                // Update active nav item
                navItems.forEach(navItem => {
                    navItem.classList.remove('active');
                });
                this.classList.add('active');
                
                // Update visible view
                viewContainers.forEach(viewContainer => {
                    viewContainer.classList.remove('active');
                });
                document.getElementById(viewToShow).classList.add('active');
                
                // Toggle body class for floating button
                if (viewToShow === 'tab-two') {
                    document.body.classList.add('tab-two-active');
                    document.body.classList.remove('tab-three-active');
                } else if (viewToShow === 'tab-three') {
                    document.body.classList.add('tab-three-active');
                    document.body.classList.remove('tab-two-active');
                } else {
                    document.body.classList.remove('tab-two-active');
                    document.body.classList.remove('tab-three-active');
                }
            });
        });
        
        // Sidebar toggle functionality
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.nav-sidebar');
        
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
            
            // Change toggle button icon based on sidebar state
            if (sidebar.classList.contains('collapsed')) {
                sidebarToggle.innerHTML = `
                    <svg class="sidebar-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                `;
            } else {
                sidebarToggle.innerHTML = `
                    <svg class="sidebar-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                `;
            }
        });
        
        // Update previews when the editor content changes
        quill.on('text-change', function() {
            updatePreviews();
        });
        
        // Update previews for second editor
        quill2.on('text-change', function() {
            updatePreviews2();
        });
        
        // Update previews for third editor
        quill3.on('text-change', function() {
            updatePreviews3();
        });
        
        // Initialize file import functionality
        document.getElementById('importButton').addEventListener('click', function() {
            requestingImportTab = 1;
            showImportModal();
        });
        
        // Initialize file import for second tab
        document.getElementById('importButton2').addEventListener('click', function() {
            requestingImportTab = 2;
            showImportModal();
        });
        
        // Initialize file import for third tab
        document.getElementById('importButton3').addEventListener('click', function() {
            requestingImportTab = 3;
            showImportModal();
        });
        
        // Close modal when X is clicked
        modalClose.addEventListener('click', closeImportModal);
        
        // Close modal when Cancel is clicked
        modalCancel.addEventListener('click', closeImportModal);
        
        // Handle modal option selection
        modalOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Remove selected class from all options
                modalOptions.forEach(opt => opt.classList.remove('selected'));
                
                // Add selected class to clicked option
                this.classList.add('selected');
                
                // Set import mode
                importMode = this.getAttribute('data-import-mode');
            });
        });
        
        // Proceed with file selection
        modalProceed.addEventListener('click', function() {
            closeImportModal();
            
            // Set accept attribute based on selected import mode
            const activeView = document.querySelector('.view-container.active').id;
            const fileInput = activeView === 'tab-one' ? 
                document.getElementById('fileInput') : 
                document.getElementById('fileInput2');
                
            if (importMode === 'word') {
                fileInput.setAttribute('accept', '.doc,.docx');
            } else {
                fileInput.setAttribute('accept', '.xlsx,.xls');
            }
            
            // Trigger file input
            fileInput.click();
        });
        
        // Open import modal
        function showImportModal() {
            importModal.style.display = 'flex';
            
            // Set default selected option
            modalOptions.forEach(option => {
                if (option.getAttribute('data-import-mode') === importMode) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }
        
        // Close import modal
        function closeImportModal() {
            importModal.style.display = 'none';
        }
        
        /**
         * Shared function to process Excel files with configuration options
         * @param {Object} config - Configuration object
         * @param {File} config.file - The Excel file to process
         * @param {Object} config.quillEditor - The Quill editor to insert content into
         * @param {string} config.statusElId - ID of the status element
         * @param {string} config.fileInputId - ID of the file input element
         * @param {Function} config.updatePreviewsFn - Function to update previews
         */
        function processExcelFileWithConfig(config) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first worksheet
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    let content = '';
                    if (importMode === 'excel-cell') {
                        // Get cell A1 content or first non-empty cell
                        const cellAddress = 'A1'; // Default cell
                        const cell = firstSheet[cellAddress];
                        content = cell ? cell.v : '';
                    } else {
                        // Convert to HTML table
                        content = XLSX.utils.sheet_to_html(firstSheet);
                    }
                    
                    // Insert into Quill editor
                    config.quillEditor.clipboard.dangerouslyPasteHTML(content);
                    
                    // Show success message
                    const statusEl = document.getElementById(config.statusElId);
                    if (statusEl) {
                        statusEl.textContent = 'File imported successfully!';
                        statusEl.className = 'import-status import-success';
                    }
                    
                    // Clear file input
                    const fileInput = document.getElementById(config.fileInputId);
                    if (fileInput) fileInput.value = '';
                    
                    // Update previews
                    if (config.updatePreviewsFn) config.updatePreviewsFn();
                } catch (error) {
                    console.error('Error parsing Excel file:', error);
                    const statusEl = document.getElementById(config.statusElId);
                    if (statusEl) {
                        statusEl.textContent = 'Error importing Excel file: ' + error.message;
                        statusEl.className = 'import-status import-error';
                    }
                    
                    // Show global error message
                    showGlobalError('Error importing Excel file: ' + error.message);
                }
            };
            reader.onerror = function() {
                const statusEl = document.getElementById(config.statusElId);
                if (statusEl) {
                    statusEl.textContent = 'Error reading file';
                    statusEl.className = 'import-status import-error';
                }
                
                // Show global error message
                showGlobalError('Error reading file');
            };
            reader.readAsArrayBuffer(config.file);
        }

        function processExcelFile(file) {
            processExcelFileWithConfig({
                file: file,
                quillEditor: quill,
                statusElId: 'importStatus',
                fileInputId: 'fileInput',
                updatePreviewsFn: updatePreviews
            });
        }

        function processExcelFile2(file) {
            processExcelFileWithConfig({
                file: file,
                quillEditor: quill2,
                statusElId: 'importStatus2',
                fileInputId: 'fileInput2',
                updatePreviewsFn: updatePreviews2
            });
        }
        
        // --- Process Excel for Tab 3 ---
        function processExcelFile3(file) {
            processExcelFileWithConfig({
                file: file,
                quillEditor: quill3,
                statusElId: 'importStatus3',
                fileInputId: 'fileInput3',
                updatePreviewsFn: updatePreviews3
            });
        }
        
        /**
         * Shared function to process Word files with configuration options
         * @param {Object} config - Configuration object
         * @param {File} config.file - The Word file to process
         * @param {Object} config.quillEditor - The Quill editor to insert content into
         * @param {string} config.statusElId - ID of the status element
         * @param {string} config.fileInputId - ID of the file input element
         * @param {Function} config.updatePreviewsFn - Function to update previews
         */
        function processWordFileWithConfig(config) {
            const reader = new FileReader();
            reader.onload = function(e) {
                mammoth.convertToHtml({ arrayBuffer: e.target.result })
                    .then(function(result) {
                        // Insert into Quill editor
                        config.quillEditor.clipboard.dangerouslyPasteHTML(result.value);
                        
                        // Show success message
                        const statusEl = document.getElementById(config.statusElId);
                        if (statusEl) {
                            statusEl.textContent = 'Word document imported successfully!';
                            statusEl.className = 'import-status import-success';
                        }
                        
                        // Clear file input
                        const fileInput = document.getElementById(config.fileInputId);
                        if (fileInput) fileInput.value = '';
                        
                        // Update previews
                        if (config.updatePreviewsFn) config.updatePreviewsFn();
                        
                        // Log any warnings
                        if (result.messages.length > 0) {
                            console.warn('Warnings during Word import:', result.messages);
                        }
                    })
                    .catch(function(error) {
                        console.error('Error parsing Word file:', error);
                        const statusEl = document.getElementById(config.statusElId);
                        if (statusEl) {
                            statusEl.textContent = 'Error importing Word file: ' + error.message;
                            statusEl.className = 'import-status import-error';
                        }
                    });
            };
            reader.onerror = function() {
                const statusEl = document.getElementById(config.statusElId);
                if (statusEl) {
                    statusEl.textContent = 'Error reading file';
                    statusEl.className = 'import-status import-error';
                }
            };
            reader.readAsArrayBuffer(config.file);
        }

        function processWordFile(file) {
            processWordFileWithConfig({
                file: file,
                quillEditor: quill,
                statusElId: 'importStatus',
                fileInputId: 'fileInput',
                updatePreviewsFn: updatePreviews
            });
        }

        function processWordFile2(file) {
            processWordFileWithConfig({
                file: file,
                quillEditor: quill2,
                statusElId: 'importStatus2',
                fileInputId: 'fileInput2',
                updatePreviewsFn: updatePreviews2
            });
        }
        
        // --- Process Word for Tab 3 ---
        function processWordFile3(file) {
            processWordFileWithConfig({
                file: file,
                quillEditor: quill3,
                statusElId: 'importStatus3',
                fileInputId: 'fileInput3',
                updatePreviewsFn: updatePreviews3
            });
        }
        
        /**
         * Shared function to update previews with configuration options
         * @param {Object} config - Configuration object
         * @param {Object} config.source - Source Quill editor
         * @param {string} config.cardAreaId - ID of card content area to update
         * @param {string} config.rawContentId - ID of the raw content textarea
         * @param {Function} config.formatDisplayFn - Function to call for updating format display
         */
        function updatePreviewsWithConfig(config) {
            // Get HTML from the source editor
            const html = config.source.root.innerHTML;
            
            // Update Card Preview if element exists and ID is provided
            if (config.cardAreaId) {
                const cardContentArea = document.getElementById(config.cardAreaId);
                if (cardContentArea) cardContentArea.innerHTML = html;
            }
            
            // Update format display based on current selection
            if (config.formatDisplayFn) config.formatDisplayFn();
            
            // Store raw content if element exists and ID is provided
            if (config.rawContentId) {
                const rawContent = document.getElementById(config.rawContentId);
                if (rawContent) rawContent.value = html;
            }
        }

        function updatePreviews() {
            // Use the shared function with tab one configuration
            updatePreviewsWithConfig({
                source: quill,
                cardAreaId: 'cardContentArea1',
                rawContentId: 'rawContent',
                formatDisplayFn: updateFormatDisplay
            });
        }

        function updatePreviews2() {
            // Use the shared function with tab two configuration
            updatePreviewsWithConfig({
                source: quill2,
                cardAreaId: 'cardContentArea2', // Note: This may not exist yet, handled by updatePreviewsAI
                rawContentId: 'rawContent2',
                formatDisplayFn: updateFormatDisplay2
            });
        }
        
        // --- Update Previews for Tab 3 ---
        function updatePreviews3() {
            // Use the shared function with tab three configuration
            // No card preview area defined for tab 3 yet
            updatePreviewsWithConfig({
                source: quill3,
                cardAreaId: null, // No dedicated card preview for tab 3 initially
                rawContentId: 'rawContent3',
                formatDisplayFn: updateFormatDisplay3
            });
            // Show/Hide clear button based on content
            const clearButton = document.getElementById('clearButton3');
            if (clearButton) {
                clearButton.style.display = quill3.getLength() > 1 ? 'flex' : 'none';
            }
        }
        
        /**
         * Shared function to toggle between HTML and Markdown formats
         * @param {Object} config - Configuration object
         * @param {string} config.format - Format to set ('html' or 'markdown')
         * @param {string} config.htmlToggleId - ID of the HTML toggle button
         * @param {string} config.markdownToggleId - ID of the Markdown toggle button
         * @param {Function} config.formatDisplayFn - Function to update the display
         * @param {Function} config.copyButtonTextFn - Function to update copy button text
         * @param {Object} config.formatRef - Reference to the format variable to update
         */
        function toggleFormatWithConfig(config) {
            // Update toggle buttons
            document.getElementById(config.htmlToggleId).classList.toggle('active', config.format === 'html');
            document.getElementById(config.markdownToggleId).classList.toggle('active', config.format === 'markdown');
            
            // Save current format by reference
            config.formatRef.current = config.format;
            
            // Update the display
            if (config.formatDisplayFn) config.formatDisplayFn();
            
            // Update copy button text
            if (config.copyButtonTextFn) config.copyButtonTextFn();
        }

        function toggleFormat(format) {
            toggleFormatWithConfig({
                format: format,
                htmlToggleId: 'htmlToggle',
                markdownToggleId: 'markdownToggle',
                formatDisplayFn: updateFormatDisplay,
                copyButtonTextFn: updateCopyButtonText,
                formatRef: { current: currentFormat }
            });
            // Update the global variable
            currentFormat = format;
        }

        function toggleFormat2(format) {
            toggleFormatWithConfig({
                format: format,
                htmlToggleId: 'htmlToggle2',
                markdownToggleId: 'markdownToggle2',
                formatDisplayFn: updateFormatDisplay2,
                copyButtonTextFn: updateCopyButtonText2,
                formatRef: { current: currentFormat2 }
            });
            // Update the global variable
            currentFormat2 = format;
        }
        
        // --- Toggle Format for Tab 3 ---
        function toggleFormat3(format) {
            toggleFormatWithConfig({
                format: format,
                htmlToggleId: 'htmlToggle3',
                markdownToggleId: 'markdownToggle3',
                formatDisplayFn: updateFormatDisplay3,
                copyButtonTextFn: updateCopyButtonText3,
                formatRef: { current: currentFormat3 }
            });
            // Update the global variable
            currentFormat3 = format;
        }
        
        /**
         * Shared function to update format display with configuration options
         * @param {Object} config - Configuration object
         * @param {Object} config.source - Source Quill editor
         * @param {string} config.inputTextId - ID of the input text element
         * @param {string|boolean} config.currentFormat - Current format (html or markdown)
         */
        function updateFormatDisplayWithConfig(config) {
            const html = config.source.root.innerHTML;
            const inputText = document.getElementById(config.inputTextId);
            
            if (!inputText) return;
            
            if (config.currentFormat === 'html') {
                inputText.value = html;
            } else {
                const markdown = new showdown.Converter().makeMarkdown(html);
                inputText.value = markdown;
            }
        }

        function updateFormatDisplay() {
            updateFormatDisplayWithConfig({
                source: quill,
                inputTextId: 'inputText',
                currentFormat: currentFormat
            });
        }

        function updateFormatDisplay2() {
            updateFormatDisplayWithConfig({
                source: quill2,
                inputTextId: 'inputText2',
                currentFormat: currentFormat2
            });
        }

        // --- Update Format Display for Tab 3 ---
        function updateFormatDisplay3() {
            updateFormatDisplayWithConfig({
                source: quill3,
                inputTextId: 'inputText3',
                currentFormat: currentFormat3
            });
        }

        /**
         * Shared function to update the copy button text based on the current format
         * @param {Object} config - Configuration object
         * @param {string} config.copyButtonId - ID of the copy button
         * @param {string} config.currentFormat - Current format ('html' or 'markdown')
         */
        function updateCopyButtonTextWithConfig(config) {
            const copyButton = document.getElementById(config.copyButtonId);
            if (!copyButton) return;
            
            if (config.currentFormat === 'html') {
                copyButton.textContent = 'Copy HTML to Clipboard';
            } else {
                copyButton.textContent = 'Copy Markdown to Clipboard';
            }
        }

        function updateCopyButtonText() {
            updateCopyButtonTextWithConfig({
                copyButtonId: 'copyButton',
                currentFormat: currentFormat
            });
        }

        function updateCopyButtonText2() {
            updateCopyButtonTextWithConfig({
                copyButtonId: 'copyButton2',
                currentFormat: currentFormat2
            });
        }
        
        // --- Update Copy Button Text for Tab 3 ---
        function updateCopyButtonText3() {
            updateCopyButtonTextWithConfig({
                copyButtonId: 'copyButton3',
                currentFormat: currentFormat3
            });
        }
        
        /**
         * Shared function to copy content to clipboard
         * @param {Object} config - Configuration object 
         * @param {string} config.inputTextId - ID of the input text element to copy from
         * @param {number} config.tabNumber - Tab number for logging
         */
        function copyToClipboardWithConfig(config) {
            const textToCopy = document.getElementById(config.inputTextId).value;
            
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    showSuccessToast("Copied to clipboard!");
                })
                .catch(err => {
                    console.error(`Failed to copy for Tab ${config.tabNumber}: `, err);
                });
        }

        function copyCurrentFormat() {
            copyToClipboardWithConfig({
                inputTextId: 'inputText',
                tabNumber: 1
            });
        }

        function copyCurrentFormat2() {
            copyToClipboardWithConfig({
                inputTextId: 'inputText2',
                tabNumber: 2
            });
        }
        
        // --- Copy Current Format for Tab 3 ---
        function copyCurrentFormat3() {
            copyToClipboardWithConfig({
                inputTextId: 'inputText3',
                tabNumber: 3
            });
        }
        
        // Card style selector for first tab
        document.getElementById('cardStyleSelector').addEventListener('change', function() {
            const selectedStyle = this.value;
            const cardPreview = document.getElementById('cardPreviewContent');
            
            // Remove all styles first - INCLUDING the new one
            cardPreview.classList.remove('text-only', 'with-intent', 'with-pills', 'with-quick-actions');
            
            // Add the selected style
            cardPreview.classList.add(selectedStyle);
        });
        
        // Initialize with sample content
        window.onload = function() {
            // Initialize first tab
            quill.root.innerHTML = "<p>Start typing or paste your content here.</p><p>Use the formatting tools above to style your text.</p>";
            updatePreviews();
            updateCopyButtonText();
            
            // Initialize second tab
            quill2.root.innerHTML = "<p>Content for AI formatting will appear here.</p><p>Paste plain text and use the Format with AI button to automatically structure it.</p>";
            updatePreviews2();
            updateCopyButtonText2();
            
            // Initialize third tab
            quill3.root.innerHTML = "<p>Paste content here for AI processing...</p>";
            updatePreviews3();
            updateCopyButtonText3();
            
            // Connect AI format button event 
            document.getElementById('aiFormatButton').addEventListener('click', formatWithAI);
            
            // Connect AI config button event
            document.getElementById('aiConfigButton').addEventListener('click', showAIConfig);
            
            // Connect AI format button for tab 3 (placeholder function for now)
            document.getElementById('aiFormatButton3').addEventListener('click', formatWithAI3); // Placeholder
            
            // Connect AI config button for tab 3 ( reusing same modal for now)
            document.getElementById('aiConfigButton3').addEventListener('click', showAIConfig);
            
            // Connect clear buttons - removed as requested
        };
        
        // Clear first editor (Content Editor tab)
        
        // Clear second editor (AI Format tab)
        
        // --- Clear third editor (AI Process tab) ---
        
        // AI formatting function that uses OpenAI API
        async function formatWithAI() {
            const aiButton = document.getElementById('aiFormatButton');
            
            // Clear any existing errors
            clearGlobalError();
            
            // Show loading state
            aiButton.classList.add('loading');
            aiButton.innerHTML = '<span class="ai-loader"></span> Formatting...';
            
            // Get provider settings
            const aiProvider = localStorage.getItem('ai_provider') || 'openai';
            
            // Get content to format
            const content = quill2.root.innerHTML;
            
            try {
                // Extract plain text from HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                const plainText = tempDiv.textContent || tempDiv.innerText || '';
                
                // --- Get the SHARED system prompt (Tab 2) --- 
                const sharedSystemPrompt = localStorage.getItem('ai_system_prompt') || document.getElementById('systemPrompt').value;
                
                // Create the prompt for formatting
                const formattingPrompt = `
                    Format the following content according to best practices. 
                    Create organized sections with clear headings, bullet points, and numbered lists as appropriate.
                    Return the formatted content as HTML that can be directly inserted into a document.
                    
                    Original content:
                    ${plainText}
                `;
                
                let formattedContent;
                
                // Based on selected provider, make appropriate API call
                if (aiProvider === 'claude') {
                    // Pass the shared system prompt
                    formattedContent = await callClaudeAPI(sharedSystemPrompt, formattingPrompt);
                } else {
                    // Default to OpenAI, pass the shared system prompt
                    formattedContent = await callOpenAIAPI(sharedSystemPrompt, formattingPrompt);
                }
                
                // Update the editor with the formatted content
                // Check if the response is HTML or plain text
                if (formattedContent.trim().startsWith('<')) {
                    // If it's HTML, insert it directly
                    quill2.clipboard.dangerouslyPasteHTML(formattedContent);
                } else {
                    // If it's plain text, wrap in paragraph tags
                    quill2.clipboard.dangerouslyPasteHTML(`<p>${formattedContent.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>')}</p>`);
                }
                
                // Update the preview
                updatePreviewsAI();
                
                // Show success message using the AI-specific toast
                showSuccessToast(`AI formatting successful with ${aiProvider === 'claude' ? 'Claude' : 'OpenAI'}!`, 'ai'); 
                                
            } catch (error) {
                console.error('Error formatting with AI:', error);
                
                // Show error message in global error container
                showGlobalError(`AI Formatting Error: ${error.message}`);
                
                // Also show in status for redundancy
                const statusEl = document.getElementById('importStatus2');
                statusEl.style.display = 'block';
                statusEl.textContent = `Error: ${error.message}`;
                statusEl.className = 'import-status import-error';
                
                // Fallback to basic formatting
                const formattedContent = applyBasicFormatting(content);
                quill2.root.innerHTML = formattedContent;
                updatePreviewsAI();
            } finally {
                // Reset button state
                aiButton.classList.remove('loading');
                aiButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"></path>
                    <path d="M12 8v8"></path>
                    <path d="M8 12h8"></path>
                </svg> Format with AI`;
            }
        }
        
        // Function to format content using OpenAI
        async function formatWithOpenAI(prompt) {
            // Get OpenAI settings
            const apiKey = localStorage.getItem('openai_api_key');
            // Use the shared system prompt setting
            const systemPrompt = localStorage.getItem('ai_system_prompt') || document.getElementById('systemPrompt').value;
            const aiModel = localStorage.getItem('ai_model') || document.getElementById('aiModel').value;
            const temperature = parseFloat(localStorage.getItem('ai_temperature') || document.getElementById('temperature').value);
            
            // Check if API key is available
            if (!apiKey) {
                // Show the config modal if no API key
                showGlobalError('Please configure your OpenAI API key to use AI formatting');
                showAIConfig();
                throw new Error('OpenAI API key not configured');
            }
            
            // Call the OpenAI API
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: aiModel,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: prompt }
                    ],
                    temperature: temperature,
                    max_tokens: 2000
                })
            });
            
            // Check if response is OK
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Unknown OpenAI API error');
            }
            
            // Parse the response
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        // Function to format content using Claude
        async function formatWithClaude(prompt) {
            // Get Claude settings
            const apiKey = localStorage.getItem('claude_api_key');
            // Use the shared system prompt setting
            const systemPrompt = localStorage.getItem('ai_system_prompt') || document.getElementById('systemPrompt').value;
            const claudeModel = localStorage.getItem('claude_model') || document.getElementById('claudeModel').value;
            const temperature = parseFloat(localStorage.getItem('claude_temperature') || document.getElementById('claudeTemperature').value);
            
            // Check if API key is available
            if (!apiKey) {
                // Show the config modal if no API key
                showGlobalError('Please configure your Claude API key to use AI formatting');
                showAIConfig();
                // Switch to the Claude tab
                switchTab('claude-panel');
                throw new Error('Claude API key not configured');
            }
            
            // Call the Claude API
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: claudeModel,
                    system: systemPrompt,
                    messages: [
                        { role: 'user', content: prompt }
                    ],
                    temperature: temperature,
                    max_tokens: 2000
                })
            });
            
            // Check if response is OK
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Unknown Claude API error');
            }
            
            // Parse the response
            const data = await response.json();
            return data.content[0].text;
        }
        
        // --- Placeholder AI Formatting function for Tab 3 ---
        async function formatWithAI3() {
            const aiButton = document.getElementById('aiFormatButton3');
            
            clearGlobalError();
            
            // Show loading state
            aiButton.classList.add('loading');
            aiButton.innerHTML = '<span class="ai-loader"></span> Processing...';
            
            // Get provider settings
            const aiProvider = localStorage.getItem('ai_provider') || 'openai';
            
            // Get content to format from quill3
            const content = quill3.root.innerHTML;
            
            try {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                // Send HTML content directly to the AI for refinement
                const htmlContent = tempDiv.innerHTML;
                
                // --- Get the SPECIFIC system prompt for Tab 3 --- 
                const systemPromptForTab3 = localStorage.getItem('ai_system_prompt_3') || document.getElementById('systemPrompt3').value;
                
                // Create the user prompt (passing the HTML content)
                const processingPrompt = `
                    Process the following HTML content based on the system instructions provided.
                    Return the processed content as valid HTML.
                    
                    Input HTML:
                    ${htmlContent}
                `;
                
                let processedContent;
                
                // Based on selected provider, make appropriate API call, passing the specific system prompt
                if (aiProvider === 'claude') {
                    processedContent = await callClaudeAPI(systemPromptForTab3, processingPrompt);
                } else {
                    processedContent = await callOpenAIAPI(systemPromptForTab3, processingPrompt);
                }
                
                // Update quill3 with the processed content
                // Assume AI returns valid HTML for this step
                quill3.clipboard.dangerouslyPasteHTML(processedContent);
                
                // Update the preview for Tab 3 (using existing function for now)
                updatePreviews3(); // Call basic preview update
                
                showSuccessToast(`AI processing successful with ${aiProvider === 'claude' ? 'Claude' : 'OpenAI'}!`, 'ai'); 
                        
            } catch (error) {
                console.error('Error processing with AI (Tab 3):', error);
                showGlobalError(`AI Processing Error: ${error.message}`);
                
                const statusEl = document.getElementById('importStatus3');
                if (statusEl) {
                    statusEl.style.display = 'block';
                    statusEl.textContent = `Error: ${error.message}`;
                    statusEl.className = 'import-status import-error';
                }
            } finally {
                // Reset button state
                aiButton.classList.remove('loading');
                aiButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg> Process with AI`; // Updated Icon and Text
            }
        }
        
        // --- Refactored OpenAI API call function ---
        async function callOpenAIAPI(systemPrompt, userPrompt) {
            const apiKey = localStorage.getItem('openai_api_key');
            const aiModel = localStorage.getItem('ai_model') || document.getElementById('aiModel').value;
            const temperature = parseFloat(localStorage.getItem('ai_temperature') || document.getElementById('temperature').value);
            
            if (!apiKey) {
                showGlobalError('Please configure your OpenAI API key.');
                showAIConfig();
                throw new Error('OpenAI API key not configured');
            }
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: aiModel,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userPrompt }
                    ],
                    temperature: temperature,
                    max_tokens: 2000
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Unknown OpenAI API error');
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        // Function to format content using Claude
        async function callClaudeAPI(systemPrompt, userPrompt) {
            const apiKey = localStorage.getItem('claude_api_key');
            const claudeModel = localStorage.getItem('claude_model') || document.getElementById('claudeModel').value;
            const temperature = parseFloat(localStorage.getItem('claude_temperature') || document.getElementById('claudeTemperature').value);
            
            if (!apiKey) {
                showGlobalError('Please configure your Claude API key.');
                showAIConfig();
                // Switch to the Claude tab in model settings view
                if (document.getElementById('model-settings-view').classList.contains('active')) {
                     switchTab('claude-panel');
                } else {
                    // If not already on model settings, switch view first, then tab
                    switchView('model-settings-view'); // This internally calls switchTab
                }
                throw new Error('Claude API key not configured');
            }
            
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: claudeModel,
                    system: systemPrompt,
                    messages: [
                        { role: 'user', content: userPrompt }
                    ],
                    temperature: temperature,
                    max_tokens: 2000
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Unknown Claude API error');
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        // Simple formatting function for the placeholder AI
        function applyBasicFormatting(content) {
            // Extract text content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            const text = tempDiv.textContent || tempDiv.innerText || '';
            
            // Split into paragraphs
            const paragraphs = text.split('\n').filter(p => p.trim().length > 0);
            
            // Format paragraphs with basic HTML
            let result = '';
            
            if (paragraphs.length === 0) {
                return '<p>No content to format</p>';
            }
            
            // Add a heading for the first short paragraph
            result += `<h2>${paragraphs[0].trim()}</h2>`;
            
            // Format remaining paragraphs
            for (let i = 1; i < paragraphs.length; i++) {
                const para = paragraphs[i].trim();
                
                if (para.length < 40 && !para.endsWith('.') && i < paragraphs.length - 1) {
                    // Short paragraphs without periods are likely subheadings
                    result += `<h3>${para}</h3>`;
                } else if (para.startsWith('- ') || para.startsWith('* ')) {
                    // Convert basic list items to proper HTML lists
                    const items = para.split(/- |\* /).filter(item => item.trim().length > 0);
                    result += '<ul>';
                    items.forEach(item => {
                        result += `<li>${item.trim()}</li>`;
                    });
                    result += '</ul>';
                } else {
                    // Regular paragraphs
                    result += `<p>${para}</p>`;
                }
            }
            
            return result;
        }

        // Function to switch tabs in the modal
        function switchTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                }
            });
            
            // Update content panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
                panel.style.display = 'none';
            });
            
            const activePanel = document.getElementById(tabId);
            if (activePanel) {
                activePanel.classList.add('active');
                activePanel.style.display = 'block';
            }
        }
        
        // Replace placeholder with actual AI config function
        function showAIConfig() {
            const aiConfigModal = document.getElementById('aiConfigModal');
            
            // Load saved settings
            loadSavedAISettings();
            
            // Show the modal
            aiConfigModal.style.display = 'flex';
            // Default to system settings view
            switchView('system-settings-view');
        }
        
        // Load saved AI settings from localStorage
        function loadSavedAISettings() {
            // General provider setting
            const aiProvider = localStorage.getItem('ai_provider');
            
            // Shared System Prompt (Tab 2)
            const systemPrompt = localStorage.getItem('ai_system_prompt');
            
            // OpenAI settings
            // const systemPrompt = localStorage.getItem('ai_system_prompt'); // Removed, using shared one
            const aiModel = localStorage.getItem('ai_model');
            const temperature = localStorage.getItem('ai_temperature');
            const apiKey = localStorage.getItem('openai_api_key');
            
            // Claude settings
            // const claudeSystemPrompt = localStorage.getItem('claude_system_prompt'); // Removed, using shared one
            const claudeModel = localStorage.getItem('claude_model');
            const claudeTemperature = localStorage.getItem('claude_temperature');
            const claudeApiKey = localStorage.getItem('claude_api_key');
            
            // Load Tab 3 System Prompt 
            const systemPrompt3 = localStorage.getItem('ai_system_prompt_3');
            
            // Set provider dropdown if available
            if (aiProvider) {
                document.getElementById('aiProvider').value = aiProvider;
                // Switch to the appropriate provider tab when Model Settings is viewed (handled by switchView)
                // switchTab(aiProvider === 'claude' ? 'claude-panel' : 'openai-panel'); // Moved logic to switchView
            }
            
            // Set Shared System Prompt (Tab 2)
            if (systemPrompt) {
                document.getElementById('systemPrompt').value = systemPrompt;
            } // No else needed, default is in HTML
            
            // Set Tab 3 System Prompt
            if (systemPrompt3) {
                document.getElementById('systemPrompt3').value = systemPrompt3;
            } // No else needed, default is in HTML
            
            // OpenAI settings (excluding system prompt)
            if (aiModel) {
                document.getElementById('aiModel').value = aiModel;
            }
            
            if (temperature) {
                document.getElementById('temperature').value = temperature;
                document.getElementById('tempValue').textContent = temperature;
            }
            
            if (apiKey) {
                document.getElementById('apiKey').value = apiKey;
            }
            
            // Claude settings (excluding system prompt)
            // if (claudeSystemPrompt) { // Removed
            //     document.getElementById('claudeSystemPrompt').value = claudeSystemPrompt; // Removed
            // } // Removed
            
            if (claudeModel) {
                document.getElementById('claudeModel').value = claudeModel;
            }
            
            if (claudeTemperature) {
                document.getElementById('claudeTemperature').value = claudeTemperature;
                document.getElementById('claudeTempValue').textContent = claudeTemperature;
            }
            
            if (claudeApiKey) {
                document.getElementById('claudeApiKey').value = claudeApiKey;
            }
        }
        
        function closeAIConfigModal() {
            const aiConfigModal = document.getElementById('aiConfigModal');
            aiConfigModal.style.display = 'none';
        }
        
        // Save AI configuration settings
        document.getElementById('aiModalSave').addEventListener('click', function() {
            // Get provider
            const aiProvider = document.getElementById('aiProvider').value;
            localStorage.setItem('ai_provider', aiProvider);
            
            // Get and Save Shared System Prompt (Tab 2)
            const systemPrompt = document.getElementById('systemPrompt').value;
            localStorage.setItem('ai_system_prompt', systemPrompt);
            
            // Get and Save Tab 3 System Prompt
            const systemPrompt3 = document.getElementById('systemPrompt3').value;
            localStorage.setItem('ai_system_prompt_3', systemPrompt3);
            
            // Save OpenAI settings 
            const aiModel = document.getElementById('aiModel').value;
            const temperature = document.getElementById('temperature').value;
            const apiKey = document.getElementById('apiKey').value;
            
            // localStorage.setItem('ai_system_prompt', systemPrompt); // Removed, saved above
            localStorage.setItem('ai_model', aiModel);
            localStorage.setItem('ai_temperature', temperature);
            
            if (apiKey) {
                localStorage.setItem('openai_api_key', apiKey);
            }
            
            // Save Claude settings (excluding system prompt)
            // const claudeSystemPrompt = document.getElementById('claudeSystemPrompt').value; // Removed
            const claudeModel = document.getElementById('claudeModel').value;
            const claudeTemperature = document.getElementById('claudeTemperature').value;
            const claudeApiKey = document.getElementById('claudeApiKey').value;
            
            // localStorage.setItem('claude_system_prompt', claudeSystemPrompt); // Removed
            localStorage.setItem('claude_model', claudeModel);
            localStorage.setItem('claude_temperature', claudeTemperature);
            
            if (claudeApiKey) {
                localStorage.setItem('claude_api_key', claudeApiKey);
            }
            
            // Close the modal
            closeAIConfigModal();
            
            // Show success message
            showSuccessToast("AI settings saved successfully!", 'settings');
        });
        
        // Initialize tab functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching for AI Config modal (Provider Tabs)
            document.querySelectorAll('#model-settings-view .modal-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // View switching for AI Config modal (System vs Model Settings)
            // Ensure this targets ONLY the top-level System/Model tabs
            document.querySelectorAll('#aiConfigModal > div.modal-tabs > button.modal-tab').forEach(tab => { 
                // Check if the button has a data-view attribute (to exclude provider tabs)
                if (tab.hasAttribute('data-view')) { 
                    tab.addEventListener('click', function() {
                        const viewId = this.getAttribute('data-view');
                        switchView(viewId);
                    });
                } 
            });

            // Temperature sliders
            const tempSlider = document.getElementById('temperature');
            const tempValue = document.getElementById('tempValue');
            tempSlider.addEventListener('input', function() {
                tempValue.textContent = this.value;
            });
            
            const claudeTempSlider = document.getElementById('claudeTemperature');
            const claudeTempValue = document.getElementById('claudeTempValue');
            claudeTempSlider.addEventListener('input', function() {
                claudeTempValue.textContent = this.value;
            });
            
            // Add event listeners for close and cancel buttons
            const aiModalClose = document.getElementById('aiModalClose');
            const aiModalCancel = document.getElementById('aiModalCancel');
            
            if (aiModalClose) {
                aiModalClose.addEventListener('click', closeAIConfigModal);
            }
            
            if (aiModalCancel) {
                aiModalCancel.addEventListener('click', closeAIConfigModal);
            }
        });
        
        // Update previews specifically after AI formatting
        function updatePreviewsAI() {
            // Get HTML from the editor
            const html = quill2.root.innerHTML;
            
            // Create or update a card content area specifically for AI
            let cardContentArea2 = document.getElementById('cardContentArea2');
            if (!cardContentArea2) {
                // Create it if it doesn't exist in the DOM yet
                cardContentArea2 = document.createElement('div');
                cardContentArea2.id = 'cardContentArea2';
            }
            
            // Update the AI preview area
            cardContentArea2.innerHTML = html;
            
            // Also update the modal preview if visible
            const modalCardContentArea = document.getElementById('modalCardContentArea');
            if (modalCardContentArea) {
                modalCardContentArea.parentElement.classList.add('with-intent');
                modalCardContentArea.innerHTML = html;
            }
            
            // Update format display based on current selection
            updateFormatDisplay2();
        }
        
        // Show global error
        function showGlobalError(errorMessage) {
            const errorContainer = document.getElementById('globalErrorContainer');
            const errorMessageEl = document.getElementById('globalErrorMessage');
            
            // Set the error message
            errorMessageEl.textContent = errorMessage;
            
            // Show the error container
            errorContainer.classList.add('visible');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                errorContainer.classList.remove('visible');
            }, 10000);
        }
        
        // Clear global error
        function clearGlobalError() {
            const errorContainer = document.getElementById('globalErrorContainer');
            errorContainer.classList.remove('visible');
        }
        
        // Renamed from showCopySuccess and added message/type parameters
        function showSuccessToast(message, type = 'success') {
            const toastElement = document.getElementById('copySuccess'); // Keep ID
            if (toastElement) {
                toastElement.innerHTML = message; // Set the message dynamically
                
                // Ensure base class is always present
                toastElement.classList.add('copy-success');
                
                // Add or remove the AI-specific color class
                if (type === 'ai') {
                    toastElement.classList.add('toast-ai'); // Add purple class
                } else {
                    toastElement.classList.remove('toast-ai'); // Remove purple class for default (green)
                }
                
                toastElement.style.display = 'block';
                setTimeout(() => {
                    toastElement.style.display = 'none';
                }, 2000);
            } else {
                console.error("Could not find toast element (copySuccess)!"); // Keep error logging
            }
        }

        // === Resizable Panes Logic ===
        const resizeHandle = document.getElementById('resize-handle');
        if (resizeHandle) { // Check if handle exists (only on tab-one)
            const editorPane = document.getElementById('editor-pane');
            const outputPane = document.getElementById('output-pane');
            // const textBox = editorPane.parentElement; // Or query directly if structure changes

            let isResizing = false;
            let startY, startEditorFlexBasis, startOutputFlexBasis;

            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startY = e.clientY;
                // Get current computed flex-basis or height as fallback
                startEditorFlexBasis = editorPane.offsetHeight;
                startOutputFlexBasis = outputPane.offsetHeight;
                
                document.body.style.cursor = 'ns-resize'; // Indicate resizing globally
                document.body.style.userSelect = 'none'; // Prevent text selection

                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('mouseup', handleMouseUp);
            });

            function handleMouseMove(e) {
                if (!isResizing) return;

                const deltaY = e.clientY - startY;
                let newEditorHeight = startEditorFlexBasis + deltaY;
                let newOutputHeight = startOutputFlexBasis - deltaY;

                // Min height constraints (adjust values as needed)
                const minEditorHeight = 100; 
                const minOutputHeight = 150;

                // Ensure we don't exceed total available height logic implicitly handled by flexbox
                // but clamp to minimums
                if (newEditorHeight < minEditorHeight) {
                    newEditorHeight = minEditorHeight;
                    newOutputHeight = (startEditorFlexBasis + startOutputFlexBasis) - newEditorHeight;
                } else if (newOutputHeight < minOutputHeight) {
                    newOutputHeight = minOutputHeight;
                    newEditorHeight = (startEditorFlexBasis + startOutputFlexBasis) - newOutputHeight;
                }

                // Set flex-basis to control size, set flex-grow to 0 during resize
                editorPane.style.flexGrow = '0';
                editorPane.style.flexShrink = '0'; // Prevent shrinking too
                editorPane.style.flexBasis = `${newEditorHeight}px`;

                outputPane.style.flexGrow = '0';
                outputPane.style.flexShrink = '0';
                outputPane.style.flexBasis = `${newOutputHeight}px`;
            }

            function handleMouseUp() {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = ''; 
                    document.body.style.userSelect = ''; 

                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                    
                    // Optional: Reset grow/shrink if needed, though basis should hold
                    // editorPane.style.flexGrow = '1'; 
                    // outputPane.style.flexGrow = '1';
                }
            }
        } // end if (resizeHandle)
        // === End Resizable Panes Logic ===

        // === Floating Preview Button & Modal Logic ===
        const showPreviewButton = document.getElementById('showPreviewButton');
        const previewModal = document.getElementById('previewModal');
        const previewModalClose = document.getElementById('previewModalClose');
        const modalCardContentArea = document.getElementById('modalCardContentArea');
        const modalCardStyleSelector = document.getElementById('modalCardStyleSelector');
        const modalCardPreviewContent = document.getElementById('modalCardPreviewContent');
        const modalTitle = previewModal.querySelector('.modal-title'); // Get modal title element

        if (showPreviewButton && previewModal && previewModalClose && modalCardContentArea && modalCardStyleSelector && modalCardPreviewContent && modalTitle) {
            
            // Show Modal
            showPreviewButton.addEventListener('click', () => {
                let content;
                let titleText;
                if (document.body.classList.contains('tab-three-active')) {
                    content = quill3.root.innerHTML; // Get content from Tab 3 editor
                    titleText = "AI Process Card Preview";
                } else { // Assumes tab-two-active if not tab-three-active
                    content = quill2.root.innerHTML; // Get content from Tab 2 editor
                    titleText = "AI Format Card Preview";
                }
                modalCardContentArea.innerHTML = content; // Set modal preview content
                modalTitle.textContent = titleText; // Set modal title
                previewModal.style.display = 'flex'; // Show modal
                document.body.classList.add('modal-open'); // Add class to body
                // Ensure initial style matches dropdown
                const currentStyle = modalCardStyleSelector.value;
                modalCardPreviewContent.classList.remove('text-only', 'with-intent', 'with-pills', 'with-quick-actions');
                modalCardPreviewContent.classList.add(currentStyle);
            });

            // Close Modal
            previewModalClose.addEventListener('click', () => {
                previewModal.style.display = 'none';
                document.body.classList.remove('modal-open'); // Remove class from body
            });

            // Optional: Close modal if clicking outside the content
            previewModal.addEventListener('click', (event) => {
                if (event.target === previewModal) { // Check if click is on the modal background
                    previewModal.style.display = 'none';
                    document.body.classList.remove('modal-open'); // Remove class from body
                }
            });
            
            // Handle style changes WITHIN the modal
            modalCardStyleSelector.addEventListener('change', function() {
                const selectedStyle = this.value;
                modalCardPreviewContent.classList.remove('text-only', 'with-intent', 'with-pills', 'with-quick-actions');
                modalCardPreviewContent.classList.add(selectedStyle);
            });

        } else {
            console.error("Could not find all required elements for modal preview.");
        }
        // === End Floating Preview Button & Modal Logic ===

        // === Screenshot Logic ===
        const screenshotButton = document.getElementById('screenshotButton'); // Modal button
        const screenshotButtonTab1 = document.getElementById('screenshotButtonTab1'); // Tab 1 button
        const modalElementToCapture = document.getElementById('modalCardPreviewContent'); 
        const tab1ElementToCapture = document.getElementById('cardPreviewContent'); 

        // Reusable function for capture and download
        function captureAndDownload(element, filename) {
            if (!element) {
                console.error("Element to capture not found!");
                showGlobalError("Cannot capture preview: target element missing.");
                return;
            }
            console.log(`Taking screenshot of ${element.id}...`);
            const options = {
                useCORS: true, 
                scale: 2, 
                backgroundColor: '#ffffff' 
            };

            html2canvas(element, options).then(canvas => {
                const imageData = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = imageData;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log("Screenshot download initiated.");
            }).catch(err => {
                console.error("Error taking screenshot:", err);
                showGlobalError("Failed to capture preview image. See console for details.");
            });
        }

        // Listener for Modal Button
        if (screenshotButton && modalElementToCapture) {
            screenshotButton.addEventListener('click', () => {
                captureAndDownload(modalElementToCapture, 'modal-card-preview.png');
            });
        } else {
            console.error("Could not find modal screenshot button or element to capture.");
        }

        // Listener for Tab 1 Button
        if (screenshotButtonTab1 && tab1ElementToCapture) {
            screenshotButtonTab1.addEventListener('click', () => {
                captureAndDownload(tab1ElementToCapture, 'card-preview.png');
            });
        } else {
            console.error("Could not find Tab 1 screenshot button or element to capture.");
        }
        // === End Screenshot Logic ===

        // Function to switch main views in the modal (System vs Model Settings)
        function switchView(viewId) {
            // Update view selector buttons - Target top-level tabs now
            document.querySelectorAll('#aiConfigModal > .modal-tabs > .modal-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-view') === viewId) {
                    tab.classList.add('active');
                }
            });

            // Update view content panels
            document.querySelectorAll('.modal-view').forEach(view => {
                view.classList.remove('active');
                view.style.display = 'none';
            });

            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.add('active');
                activeView.style.display = 'block';
                // If switching to model settings, ensure the correct provider tab is shown based on default provider
                if (viewId === 'model-settings-view') {
                     const defaultProvider = document.getElementById('aiProvider').value || 'openai';
                     switchTab(defaultProvider === 'claude' ? 'claude-panel' : 'openai-panel');
                }
            }
        }

        // Handle file input change for first tab
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const statusEl = document.getElementById('importStatus');
            statusEl.style.display = 'block';
            statusEl.textContent = 'Importing file...';
            statusEl.className = 'import-status';
            
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            // Check if file type matches selected import mode
            if ((fileExt === 'xlsx' || fileExt === 'xls') && importMode.startsWith('excel')) {
                processExcelFile(file);
            } else if ((fileExt === 'doc' || fileExt === 'docx') && importMode === 'word') {
                processWordFile(file);
            } else {
                statusEl.textContent = 'Error: File type does not match selected import mode';
                statusEl.className = 'import-status import-error';
            }
        });

        // Handle file input change for second tab
        document.getElementById('fileInput2').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const statusEl = document.getElementById('importStatus2');
            statusEl.style.display = 'block';
            statusEl.textContent = 'Importing file...';
            statusEl.className = 'import-status';
            
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            // Check if file type matches selected import mode
            if ((fileExt === 'xlsx' || fileExt === 'xls') && importMode.startsWith('excel')) {
                processExcelFile2(file);
            } else if ((fileExt === 'doc' || fileExt === 'docx') && importMode === 'word') {
                processWordFile2(file);
            } else {
                statusEl.textContent = 'Error: File type does not match selected import mode';
                statusEl.className = 'import-status import-error';
            }
        });

        // --- Handle file input change for third tab ---
        document.getElementById('fileInput3').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const statusEl = document.getElementById('importStatus3');
            if (statusEl) {
                statusEl.style.display = 'block';
                statusEl.textContent = 'Importing file...';
                statusEl.className = 'import-status';
            }
            
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            // Check if file type matches selected import mode (uses the same global 'importMode')
            if ((fileExt === 'xlsx' || fileExt === 'xls') && importMode.startsWith('excel')) {
                processExcelFile3(file); // Use Tab 3 function
            } else if ((fileExt === 'doc' || fileExt === 'docx') && importMode === 'word') {
                processWordFile3(file); // Use Tab 3 function
            } else {
                if (statusEl) {
                    statusEl.textContent = 'Error: File type does not match selected import mode';
                    statusEl.className = 'import-status import-error';
                }
            }
        });

        // --- AI Formatting function for Tab 3 (Replace Placeholder) ---
        async function formatWithAI3() {
            const aiButton = document.getElementById('aiFormatButton3');
            
            clearGlobalError();
            
            // Show loading state
            aiButton.classList.add('loading');
            aiButton.innerHTML = '<span class="ai-loader"></span> Processing...';
            
            // Get provider settings
            const aiProvider = localStorage.getItem('ai_provider') || 'openai';
            
            // Get content to format from quill3
            const content = quill3.root.innerHTML;
            
            try {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                // Send HTML content directly to the AI for refinement
                const htmlContent = tempDiv.innerHTML;
                
                // --- Get the SPECIFIC system prompt for Tab 3 --- 
                const systemPromptForTab3 = localStorage.getItem('ai_system_prompt_3') || document.getElementById('systemPrompt3').value;
                
                // Create the user prompt (passing the HTML content)
                const processingPrompt = `
                    Process the following HTML content based on the system instructions provided.
                    Return the processed content as valid HTML.
                    
                    Input HTML:
                    ${htmlContent}
                `;
                
                let processedContent;
                
                // Based on selected provider, make appropriate API call, passing the specific system prompt
                if (aiProvider === 'claude') {
                    processedContent = await callClaudeAPI(systemPromptForTab3, processingPrompt);
                } else {
                    processedContent = await callOpenAIAPI(systemPromptForTab3, processingPrompt);
                }
                
                // Update quill3 with the processed content
                // Assume AI returns valid HTML for this step
                quill3.clipboard.dangerouslyPasteHTML(processedContent);
                
                // Update the preview for Tab 3 (using existing function for now)
                updatePreviews3(); // Call basic preview update
                
                showSuccessToast(`AI processing successful with ${aiProvider === 'claude' ? 'Claude' : 'OpenAI'}!`, 'ai'); 
                
            } catch (error) {
                console.error('Error processing with AI (Tab 3):', error);
                showGlobalError(`AI Processing Error: ${error.message}`);
                
                const statusEl = document.getElementById('importStatus3');
                if (statusEl) {
                    statusEl.style.display = 'block';
                    statusEl.textContent = `Error: ${error.message}`;
                    statusEl.className = 'import-status import-error';
                }
            } finally {
                // Reset button state
                aiButton.classList.remove('loading');
                aiButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg> Process with AI`;
            }
        }
    </script>
</body>
</html>